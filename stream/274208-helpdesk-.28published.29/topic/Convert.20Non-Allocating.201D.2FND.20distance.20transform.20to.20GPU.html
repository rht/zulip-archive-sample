<html>
<head><meta charset="utf-8"><title>Convert Non-Allocating 1D/ND distance transform to GPU · helpdesk (published) · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rht.github.io/zulip-archive-sample/stream/274208-helpdesk-.28published.29/index.html">helpdesk (published)</a></h2>
<h3>Topic: <a href="https://rht.github.io/zulip-archive-sample/stream/274208-helpdesk-.28published.29/topic/Convert.20Non-Allocating.201D.2FND.20distance.20transform.20to.20GPU.html">Convert Non-Allocating 1D/ND distance transform to GPU</a></h3>

<hr>

<base href="https://julialang.zulipchat.com/">

<head><link href="https://rht.github.io/zulip-archive-sample/style.css" rel="stylesheet"></head>

<a name="399820826"></a>
<h4><a href="https://julialang.zulipchat.com/#narrow/stream/274208-helpdesk%20%28published%29/topic/Convert%20Non-Allocating%201D/ND%20distance%20transform%20to%20GPU/near/399820826" class="zl"><img src="https://rht.github.io/zulip-archive-sample/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dale Black <a href="https://rht.github.io/zulip-archive-sample/stream/274208-helpdesk-.28published.29/topic/Convert.20Non-Allocating.201D.2FND.20distance.20transform.20to.20GPU.html#399820826">(Nov 01 2023 at 23:55)</a>:</h4>
<p>I have a 1D and 2D distance transform algorithm for the CPU that is non-allocating. I want to convert this to the GPU via <a href="https://juliahub.com/ui/Packages/General/KernelAbstractions">KernelAbstractions.jl</a>, and I have two ideas, but I can't figure out either one. </p>
<p>The first idea is to directly convert the 1D transform (that is used for all ND transforms) and go from there. This produces incorrect results for any vector of size greater than 128. This also might not be the best approach since the Felzenszwalb is easily parallelizable across many dimensions.</p>
<p>Hence, the other idea is to use the non-allocating 1D CPU transform to create a 2D/ND GPU kernel that runs the 1D transform across rows/columns. I have no idea how to start this or if this works. I was previously using <a href="https://juliahub.com/ui/Packages/General/FLoops">FLoops.jl</a> for something like this, though, so it should work, I suppose.</p>
<p>Does anyone with real GPU knowledge know how I should tackle this problem? I attached the 1D and 2D CPU versions and a full notebook running the code below that uses the <a href="https://juliahub.com/ui/Packages/General/Metal">Metal.jl</a> backend since I am on a Mac, but it should work with CUDA or AMDGPU automatically (hopefully)</p>
<h2>just the transforms</h2>
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="k">function</span><span class="w"> </span><span class="n">transform!</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w">  </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nb">Inf</span>
<span class="w">    </span><span class="n">z</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Inf</span>

<span class="w">    </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="nd">@inbounds</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">2</span><span class="o">:</span><span class="n">length</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="w">        </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">^</span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">≤</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="w">            </span><span class="n">k</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">            </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">^</span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="n">k</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q</span>
<span class="w">        </span><span class="n">z</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span>
<span class="w">        </span><span class="n">z</span><span class="p">[</span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Inf</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="nd">@inbounds</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">length</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">q</span>
<span class="w">            </span><span class="n">k</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="n">output</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">q</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">^</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="n">transform!</span><span class="p">(</span><span class="n">img</span><span class="o">::</span><span class="kt">AbstractMatrix</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">;</span><span class="w"> </span><span class="n">threaded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">threaded</span>
<span class="w">        </span><span class="n">Threads</span><span class="o">.</span><span class="nd">@threads</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">CartesianIndices</span><span class="p">(</span><span class="nd">@view</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]))</span>
<span class="w">            </span><span class="nd">@views</span><span class="w"> </span><span class="n">transform!</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">])</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="n">Threads</span><span class="o">.</span><span class="nd">@threads</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">CartesianIndices</span><span class="p">(</span><span class="nd">@view</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">]))</span>
<span class="w">            </span><span class="nd">@views</span><span class="w"> </span><span class="n">transform!</span><span class="p">(</span>
<span class="w">                </span><span class="n">output</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">],</span><span class="w"> </span><span class="n">output</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">],</span><span class="w"> </span><span class="n">fill!</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">fill!</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">CartesianIndices</span><span class="p">(</span><span class="nd">@view</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]))</span>
<span class="w">            </span><span class="nd">@views</span><span class="w"> </span><span class="n">transform!</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">])</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">CartesianIndices</span><span class="p">(</span><span class="nd">@view</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">]))</span>
<span class="w">            </span><span class="nd">@views</span><span class="w"> </span><span class="n">transform!</span><span class="p">(</span>
<span class="w">                </span><span class="n">output</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">],</span><span class="w"> </span><span class="n">output</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">],</span><span class="w"> </span><span class="n">fill!</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">fill!</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h2>full notebook MWE</h2>
<div class="spoiler-block"><div class="spoiler-header">
<p>MWE</p>
</div><div class="spoiler-content" aria-hidden="true">
<div class="codehilite" data-code-language="Julia"><pre><span></span><code><span class="c"># ╔═╡ 5f2c5e46-f61e-4848-848a-5f856b7e7035</span>
<span class="k">using</span><span class="w"> </span><span class="n">ImageMorphology</span>

<span class="c"># ╔═╡ 05940c0b-ada1-4c6c-8391-9a2576734e28</span>
<span class="k">using</span><span class="w"> </span><span class="n">PlutoUI</span>

<span class="c"># ╔═╡ fe0fd9b3-84db-4599-9416-55e6a10599fe</span>
<span class="k">using</span><span class="w"> </span><span class="n">KernelAbstractions</span>

<span class="c"># ╔═╡ 9662e414-85bf-4557-bd8c-ed1a14795989</span>
<span class="k">using</span><span class="w"> </span><span class="n">BenchmarkTools</span>

<span class="c"># ╔═╡ b215eaa5-ab18-4fd6-a963-8b879c9101f2</span>
<span class="k">using</span><span class="w"> </span><span class="n">Metal</span><span class="p">,</span><span class="w"> </span><span class="n">CUDA</span><span class="p">,</span><span class="w"> </span><span class="n">AMDGPU</span>

<span class="c"># ╔═╡ 2b1113d0-1590-427d-b563-9de052369709</span>
<span class="k">if</span><span class="w"> </span><span class="n">CUDA</span><span class="o">.</span><span class="n">functional</span><span class="p">()</span>
<span class="w">    </span><span class="nd">@info</span><span class="w"> </span><span class="s">"Using CUDA"</span>
<span class="w">    </span><span class="n">CUDA</span><span class="o">.</span><span class="n">versioninfo</span><span class="p">()</span>
<span class="w">    </span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CuArray</span>
<span class="k">elseif</span><span class="w"> </span><span class="n">AMDGPU</span><span class="o">.</span><span class="n">functional</span><span class="p">()</span>
<span class="w">    </span><span class="nd">@info</span><span class="w"> </span><span class="s">"Using AMD"</span>
<span class="w">    </span><span class="n">AMDGPU</span><span class="o">.</span><span class="n">versioninfo</span><span class="p">()</span>
<span class="w">    </span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ROCArray</span>
<span class="k">elseif</span><span class="w"> </span><span class="n">Metal</span><span class="o">.</span><span class="n">functional</span><span class="p">()</span>
<span class="w">    </span><span class="nd">@info</span><span class="w"> </span><span class="s">"Using Metal"</span>
<span class="w">    </span><span class="n">Metal</span><span class="o">.</span><span class="n">versioninfo</span><span class="p">()</span>
<span class="w">    </span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MtlArray</span>
<span class="k">else</span>
<span class="w">    </span><span class="nd">@info</span><span class="w"> </span><span class="s">"No GPU is available. Using CPU."</span>
<span class="k">end</span>

<span class="c"># ╔═╡ e371818f-8f34-4de2-b8e3-54b429dcedbb</span>
<span class="n">TableOfContents</span><span class="p">()</span>

<span class="c"># ╔═╡ 870db4ba-4d25-40f3-afdd-f5a5f7a5b4f8</span>
<span class="sa">md</span><span class="s">"""</span>
<span class="s"># Transform (CPU)</span>
<span class="s">"""</span>

<span class="c"># ╔═╡ a1d56f5f-6b71-459b-ba8b-77512a9dd763</span>
<span class="n">boolean_indicator</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nd">@.</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1f10</span><span class="p">,</span><span class="w"> </span><span class="mf">0f0</span><span class="p">)</span>

<span class="c"># ╔═╡ 5f02ea61-1d05-4fdc-8abd-15d1f1170622</span>
<span class="n">test_transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">distance_transform</span><span class="p">(</span><span class="n">feature_transform</span><span class="p">(</span><span class="kt">Bool</span><span class="o">.</span><span class="p">(</span><span class="n">img</span><span class="p">)))</span>

<span class="c"># ╔═╡ f0560da9-f819-4378-8596-36567092eedb</span>
<span class="sa">md</span><span class="s">"""</span>
<span class="s">## 1D</span>
<span class="s">"""</span>

<span class="c"># ╔═╡ 0442e062-b337-411c-9cd2-ab7369a5e66b</span>
<span class="k">function</span><span class="w"> </span><span class="n">transform!</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w">  </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nb">Inf</span>
<span class="w">    </span><span class="n">z</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Inf</span>

<span class="w">    </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="nd">@inbounds</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">2</span><span class="o">:</span><span class="n">length</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="w">        </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">^</span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">≤</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="w">            </span><span class="n">k</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">            </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">^</span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="n">k</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q</span>
<span class="w">        </span><span class="n">z</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span>
<span class="w">        </span><span class="n">z</span><span class="p">[</span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Inf</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="nd">@inbounds</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">length</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">q</span>
<span class="w">            </span><span class="n">k</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="n">output</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">q</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">^</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>

<span class="c"># ╔═╡ 074f7359-ba25-4ee8-9496-857af598898c</span>
<span class="k">let</span>
<span class="w">    </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">128</span>
<span class="w">    </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">([</span><span class="mf">0f0</span><span class="p">,</span><span class="w"> </span><span class="mf">1f0</span><span class="p">],</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">    </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">similar</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="kt">Float32</span><span class="p">)</span>
<span class="w">    </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ones</span><span class="p">(</span><span class="kt">Int32</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
<span class="w">    </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ones</span><span class="p">(</span><span class="kt">Float32</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="n">f_bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boolean_indicator</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="w">    </span><span class="n">transform!</span><span class="p">(</span><span class="n">f_bool</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>

<span class="w">    </span><span class="n">f_test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test_transform</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.^</span><span class="mi">2</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@info</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">≈</span><span class="w"> </span><span class="n">f_test</span>
<span class="k">end</span><span class="p">;</span>

<span class="c"># ╔═╡ 8d4abe67-b7dc-4828-a5a5-2c0c815d6916</span>
<span class="k">let</span>
<span class="w">    </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">128</span>
<span class="w">    </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">([</span><span class="mf">0f0</span><span class="p">,</span><span class="w"> </span><span class="mf">1f0</span><span class="p">],</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">    </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">similar</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="kt">Float32</span><span class="p">)</span>
<span class="w">    </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ones</span><span class="p">(</span><span class="kt">Int32</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
<span class="w">    </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ones</span><span class="p">(</span><span class="kt">Float32</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="n">f_bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boolean_indicator</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@benchmark</span><span class="w"> </span><span class="n">transform!</span><span class="p">(</span><span class="o">$</span><span class="n">f_bool</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">z</span><span class="p">)</span>
<span class="k">end</span>

<span class="c"># ╔═╡ 0c931c1f-a14f-4024-9610-85334033d943</span>
<span class="sa">md</span><span class="s">"""</span>
<span class="s">## 2D</span>
<span class="s">"""</span>

<span class="c"># ╔═╡ c39b92e8-31b8-46d7-8655-79dc2349a6c0</span>
<span class="k">function</span><span class="w"> </span><span class="n">transform!</span><span class="p">(</span><span class="n">img</span><span class="o">::</span><span class="kt">AbstractMatrix</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">;</span><span class="w"> </span><span class="n">threaded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">threaded</span>
<span class="w">        </span><span class="n">Threads</span><span class="o">.</span><span class="nd">@threads</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">CartesianIndices</span><span class="p">(</span><span class="nd">@view</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]))</span>
<span class="w">            </span><span class="nd">@views</span><span class="w"> </span><span class="n">transform!</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">])</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="n">Threads</span><span class="o">.</span><span class="nd">@threads</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">CartesianIndices</span><span class="p">(</span><span class="nd">@view</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">]))</span>
<span class="w">            </span><span class="nd">@views</span><span class="w"> </span><span class="n">transform!</span><span class="p">(</span>
<span class="w">                </span><span class="n">output</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">],</span><span class="w"> </span><span class="n">output</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">],</span><span class="w"> </span><span class="n">fill!</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">fill!</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">CartesianIndices</span><span class="p">(</span><span class="nd">@view</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]))</span>
<span class="w">            </span><span class="nd">@views</span><span class="w"> </span><span class="n">transform!</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">])</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kt">CartesianIndices</span><span class="p">(</span><span class="nd">@view</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">]))</span>
<span class="w">            </span><span class="nd">@views</span><span class="w"> </span><span class="n">transform!</span><span class="p">(</span>
<span class="w">                </span><span class="n">output</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">],</span><span class="w"> </span><span class="n">output</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">],</span><span class="w"> </span><span class="n">fill!</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">fill!</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>

<span class="c"># ╔═╡ 7957fcf8-d8d9-415d-9367-09aec00cf5b7</span>
<span class="k">let</span>
<span class="w">    </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span>
<span class="w">    </span><span class="n">img</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">([</span><span class="mf">0f0</span><span class="p">,</span><span class="w"> </span><span class="mf">1f0</span><span class="p">],</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">    </span><span class="n">img_bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boolean_indicator</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="w">    </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">similar</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="w"> </span><span class="kt">Float32</span><span class="p">)</span>
<span class="w">    </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ones</span><span class="p">(</span><span class="kt">Int32</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>
<span class="w">    </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ones</span><span class="p">(</span><span class="kt">Float32</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">transform!</span><span class="p">(</span><span class="n">img_bool</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>

<span class="w">    </span><span class="n">img_test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test_transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.^</span><span class="mi">2</span>
<span class="w">    </span><span class="nd">@info</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">≈</span><span class="w"> </span><span class="n">img_test</span>
<span class="k">end</span><span class="p">;</span>

<span class="c"># ╔═╡ f5d7fdfd-cd40-402c-b2e6-031ec15354cf</span>
<span class="k">let</span>
<span class="w">    </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span>
<span class="w">    </span><span class="n">img</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">([</span><span class="mf">0f0</span><span class="p">,</span><span class="w"> </span><span class="mf">1f0</span><span class="p">],</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">    </span><span class="n">img_bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boolean_indicator</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="w">    </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">similar</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="w"> </span><span class="kt">Float32</span><span class="p">)</span>
<span class="w">    </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ones</span><span class="p">(</span><span class="kt">Int32</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>
<span class="w">    </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ones</span><span class="p">(</span><span class="kt">Float32</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">transform!</span><span class="p">(</span><span class="n">img_bool</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">;</span><span class="w"> </span><span class="n">threaded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span>

<span class="w">    </span><span class="n">img_test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test_transform</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.^</span><span class="mi">2</span>
<span class="w">    </span><span class="nd">@info</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">≈</span><span class="w"> </span><span class="n">img_test</span>
<span class="k">end</span><span class="p">;</span>

<span class="c"># ╔═╡ 828511d3-7b50-4016-96e0-1c8270365359</span>
<span class="k">let</span>
<span class="w">    </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span>
<span class="w">    </span><span class="n">img</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">([</span><span class="mf">0f0</span><span class="p">,</span><span class="w"> </span><span class="mf">1f0</span><span class="p">],</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">    </span><span class="n">img_bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boolean_indicator</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="w">    </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">similar</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="w"> </span><span class="kt">Float32</span><span class="p">)</span>
<span class="w">    </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ones</span><span class="p">(</span><span class="kt">Int32</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>
<span class="w">    </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ones</span><span class="p">(</span><span class="kt">Float32</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@benchmark</span><span class="w"> </span><span class="n">transform!</span><span class="p">(</span><span class="o">$</span><span class="n">img_bool</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">z</span><span class="p">;</span><span class="w"> </span><span class="n">threaded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="nb">false</span><span class="p">)</span>
<span class="k">end</span>

<span class="c"># ╔═╡ cfd1d965-78b1-4e9c-b6dc-46d68535b215</span>
<span class="sa">md</span><span class="s">"""</span>
<span class="s"># Transform (GPU)</span>
<span class="s">"""</span>

<span class="c"># ╔═╡ 917d8727-cf76-4828-8865-4ed316ef2b77</span>
<span class="nd">@kernel</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">boolean_indicator_kernel</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">)</span>
<span class="w">    </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nd">@index</span><span class="p">(</span><span class="n">Global</span><span class="p">)</span>
<span class="w">    </span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1f10</span><span class="p">,</span><span class="w"> </span><span class="mf">0f0</span><span class="p">)</span>
<span class="k">end</span>

<span class="c"># ╔═╡ 4ea882a1-2956-4603-805d-796722cfa2f9</span>
<span class="k">function</span><span class="w"> </span><span class="n">boolean_indicator_gpu</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="w">    </span><span class="n">backend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_backend</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="w">    </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">similar</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="kt">Float32</span><span class="p">)</span>
<span class="w">    </span><span class="n">kernel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boolean_indicator_kernel</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span>
<span class="w">    </span><span class="n">kernel</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">ndrange</span><span class="o">=</span><span class="n">size</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
<span class="w">    </span><span class="n">KernelAbstractions</span><span class="o">.</span><span class="n">synchronize</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">output</span>
<span class="k">end</span>

<span class="c"># ╔═╡ 1348e72b-2590-40c6-9640-cffd0a605908</span>
<span class="k">let</span>
<span class="w">    </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">([</span><span class="mf">0f0</span><span class="p">,</span><span class="w"> </span><span class="mf">1f0</span><span class="p">],</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span>
<span class="w">    </span><span class="n">f_gpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@info</span><span class="w"> </span><span class="n">boolean_indicator</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kt">Array</span><span class="p">(</span><span class="n">boolean_indicator_gpu</span><span class="p">(</span><span class="n">f_gpu</span><span class="p">))</span>

<span class="w">    </span><span class="n">img</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">([</span><span class="mf">0f0</span><span class="p">,</span><span class="w"> </span><span class="mf">1f0</span><span class="p">],</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="w">    </span><span class="n">img_gpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@info</span><span class="w"> </span><span class="n">boolean_indicator</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kt">Array</span><span class="p">(</span><span class="n">boolean_indicator_gpu</span><span class="p">(</span><span class="n">img_gpu</span><span class="p">))</span>
<span class="k">end</span>

<span class="c"># ╔═╡ 5669a0b9-5fea-4562-8dc6-1960992971ce</span>
<span class="sa">md</span><span class="s">"""</span>
<span class="s">## 1D</span>
<span class="s">"""</span>

<span class="c"># ╔═╡ 746cb1e5-7da5-4787-8774-32f3f7b3644a</span>
<span class="nd">@kernel</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">transform_kernel</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nd">@index</span><span class="p">(</span><span class="n">Global</span><span class="p">)</span>
<span class="w">    </span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nb">Inf</span>
<span class="w">    </span><span class="n">z</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Inf</span>

<span class="w">    </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">q_inner</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">2</span><span class="o">:</span><span class="n">q</span>
<span class="w">        </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="n">q_inner</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q_inner</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">^</span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q_inner</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">≤</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
<span class="w">            </span><span class="n">k</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">            </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">f</span><span class="p">[</span><span class="n">q_inner</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q_inner</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">^</span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">q_inner</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="n">k</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q_inner</span>
<span class="w">        </span><span class="n">z</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span>
<span class="w">        </span><span class="n">z</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1f10</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">q_inner</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">q</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">q_inner</span>
<span class="w">            </span><span class="n">k</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="n">output</span><span class="p">[</span><span class="n">q_inner</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">q_inner</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">^</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>

<span class="c"># ╔═╡ c7ac753c-eca5-4d9c-b3f1-fbe6eba6f905</span>
<span class="k">function</span><span class="w"> </span><span class="n">transform_gpu!</span><span class="p">(</span><span class="n">f</span><span class="o">::</span><span class="kt">AbstractVector</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">    </span><span class="n">backend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_backend</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="w">    </span><span class="n">kernel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transform_kernel</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span>
<span class="w">    </span><span class="n">kernel</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">ndrange</span><span class="o">=</span><span class="n">length</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
<span class="w">    </span><span class="n">KernelAbstractions</span><span class="o">.</span><span class="n">synchronize</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span>
<span class="k">end</span>

<span class="c"># ╔═╡ 39ceb6a2-4864-4187-99dc-a5a109ae6da2</span>
<span class="k">let</span>
<span class="w">    </span><span class="c"># n = 128</span>
<span class="w">    </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">300</span>
<span class="w">    </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">([</span><span class="mf">0f0</span><span class="p">,</span><span class="w"> </span><span class="mf">1f0</span><span class="p">],</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">    </span><span class="n">f_gpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="w">    </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="p">(</span><span class="n">similar</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="kt">Float32</span><span class="p">))</span>
<span class="w">    </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="p">(</span><span class="n">ones</span><span class="p">(</span><span class="kt">Int32</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">f</span><span class="p">)))</span>
<span class="w">    </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="p">(</span><span class="n">ones</span><span class="p">(</span><span class="kt">Float32</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">    </span><span class="n">f_bool_gpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boolean_indicator_gpu</span><span class="p">(</span><span class="n">f_gpu</span><span class="p">)</span>
<span class="w">    </span><span class="n">transform_gpu!</span><span class="p">(</span><span class="n">f_bool_gpu</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>

<span class="w">    </span><span class="n">f_test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test_transform</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.^</span><span class="mi">2</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@info</span><span class="w"> </span><span class="kt">Array</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="w"> </span><span class="o">≈</span><span class="w"> </span><span class="n">f_test</span>
<span class="k">end</span>
</code></pre></div>
</div></div>



<hr><p>Last updated: Nov 01 2025 at 04:40 UTC</p>
</html>